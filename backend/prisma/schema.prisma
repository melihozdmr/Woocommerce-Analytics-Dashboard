// Prisma Schema for WooCommerce Analytics Dashboard
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  USER
  ADMIN
}

enum PlanType {
  FREE
  PRO
  ENTERPRISE
}

enum StoreStatus {
  ACTIVE
  INACTIVE
  ERROR
}

enum CompanyRole {
  OWNER
  ADMIN
  MEMBER
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

// ==================== MODELS ====================

model User {
  id                       String    @id @default(cuid())
  email                    String    @unique
  password                 String
  name                     String?
  role                     UserRole  @default(USER)
  planId                   String?   @map("plan_id")
  currentCompanyId         String?   @map("current_company_id")
  grandfathered            Boolean   @default(false)
  isActive                 Boolean   @default(true) @map("is_active")
  isEmailVerified          Boolean   @default(false) @map("is_email_verified")
  emailVerificationCode    String?   @map("email_verification_code")
  emailVerificationExpiry  DateTime? @map("email_verification_expiry")
  lastLoginAt              DateTime? @map("last_login_at")
  resetToken               String?   @map("reset_token")
  resetTokenExpiry         DateTime? @map("reset_token_expiry")
  createdAt                DateTime  @default(now()) @map("created_at")
  updatedAt                DateTime  @updatedAt @map("updated_at")

  // Relations
  plan                  Plan?                  @relation(fields: [planId], references: [id])
  currentCompany        Company?               @relation("CurrentCompany", fields: [currentCompanyId], references: [id])
  companyMembers        CompanyMember[]
  refreshTokens         RefreshToken[]
  notifications         Notification[]
  notificationSettings  NotificationSetting[]

  @@map("users")
}

model Company {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  logo        String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  members                    CompanyMember[]
  stores                     Store[]
  currentUsers               User[] @relation("CurrentCompany")
  productMappings            ProductMapping[]
  dismissedMappingSuggestions DismissedMappingSuggestion[]
  apiKeys                    ApiKey[]

  @@map("companies")
}

model CompanyMember {
  id          String      @id @default(cuid())
  companyId   String      @map("company_id")
  userId      String?     @map("user_id")
  email       String      // Davet edilen e-posta
  role        CompanyRole @default(MEMBER)
  inviteToken String?     @unique @map("invite_token")
  inviteStatus InviteStatus @default(PENDING) @map("invite_status")
  invitedAt   DateTime    @default(now()) @map("invited_at")
  joinedAt    DateTime?   @map("joined_at")

  // Relations
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user        User?       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([companyId, email])
  @@index([inviteToken])
  @@map("company_members")
}

model Plan {
  id              String   @id @default(cuid())
  name            PlanType @unique
  displayName     String   @map("display_name")
  storeLimit      Int      @map("store_limit")
  refreshInterval Int      @default(15) @map("refresh_interval") // dakika
  historyDays     Int      @default(30) @map("history_days")
  priceMonthly    Decimal  @default(0) @map("price_monthly") @db.Decimal(10, 2)
  priceYearly     Decimal  @default(0) @map("price_yearly") @db.Decimal(10, 2)
  features        Json     @default("{}")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  users User[]

  @@map("plans")
}

model Store {
  id             String      @id @default(cuid())
  companyId      String      @map("company_id")
  name           String
  url            String
  consumerKey    String      @map("consumer_key") // Encrypted - WooCommerce API
  consumerSecret String      @map("consumer_secret") // Encrypted - WooCommerce API
  wcscApiKey     String?     @map("wcsc_api_key") // WC Stock Connector API Key
  wcscApiSecret  String?     @map("wcsc_api_secret") // WC Stock Connector API Secret
  wcscWebhookSecret String?  @map("wcsc_webhook_secret") // Webhook HMAC secret
  hasWcscPlugin  Boolean     @default(false) @map("has_wcsc_plugin") // WC Stock Connector eklentisi kurulu mu?
  wcscConnectedAt DateTime?  @map("wcsc_connected_at") // İlk bağlantı zamanı
  wcscLastSyncAt  DateTime?  @map("wcsc_last_sync_at") // Son sync zamanı
  commissionRate Decimal     @default(0) @map("commission_rate") @db.Decimal(5, 2) // 0-100%
  shippingCost   Decimal     @default(0) @map("shipping_cost") @db.Decimal(10, 2) // TL
  currency       String      @default("TRY")
  status         StoreStatus @default(ACTIVE)
  isSyncing      Boolean     @default(false) @map("is_syncing")
  syncStep       String?     @map("sync_step") // connection, products, variations, orders, saving
  syncProductsCount   Int?   @map("sync_products_count")
  syncVariationsCount Int?   @map("sync_variations_count")
  syncOrdersCount     Int?   @map("sync_orders_count")
  lastSyncAt     DateTime?   @map("last_sync_at")
  syncError      String?     @map("sync_error")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  // Relations
  company             Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  analyticsCache      AnalyticsCache[]
  products            Product[]
  orders              Order[]
  productMappingItems ProductMappingItem[]
  webhookLogs         WebhookLog[]

  @@map("stores")
}

model Product {
  id            String   @id @default(cuid())
  storeId       String   @map("store_id")
  wcProductId   Int      @map("wc_product_id") // WooCommerce product ID
  name          String
  sku           String?
  imageUrl      String?  @map("image_url") // Ürün görseli URL
  productType   String   @default("simple") @map("product_type") // simple, variable, grouped, external
  price         Decimal  @default(0) @db.Decimal(10, 2) // Satış fiyatı
  purchasePrice Decimal? @map("purchase_price") @db.Decimal(10, 2) // Alış fiyatı
  stockQuantity Int      @default(0) @map("stock_quantity")
  stockStatus   String   @default("instock") @map("stock_status")
  manageStock   Boolean  @default(false) @map("manage_stock")
  isActive      Boolean  @default(true) @map("is_active")
  syncedAt      DateTime @default(now()) @map("synced_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  store               Store                @relation(fields: [storeId], references: [id], onDelete: Cascade)
  variations          ProductVariation[]
  orderItems          OrderItem[]
  productMappingItems ProductMappingItem[]

  @@unique([storeId, wcProductId])
  @@map("products")
}

model ProductVariation {
  id              String   @id @default(cuid())
  productId       String   @map("product_id")
  wcVariationId   Int      @map("wc_variation_id") // WooCommerce variation ID
  sku             String?
  price           Decimal  @default(0) @db.Decimal(10, 2)
  purchasePrice   Decimal? @map("purchase_price") @db.Decimal(10, 2) // Alış fiyatı
  stockQuantity   Int      @default(0) @map("stock_quantity")
  stockStatus     String   @default("instock") @map("stock_status")
  manageStock     Boolean  @default(false) @map("manage_stock")
  attributes      Json?    // { "Beden": "XL", "Renk": "Kırmızı" }
  attributeString String?  @map("attribute_string") // "XL / Kırmızı" - for display
  isActive        Boolean  @default(true) @map("is_active")
  syncedAt        DateTime @default(now()) @map("synced_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, wcVariationId])
  @@map("product_variations")
}

model Order {
  id              String   @id @default(cuid())
  storeId         String   @map("store_id")
  wcOrderId       Int      @map("wc_order_id") // WooCommerce order ID
  orderNumber     String   @map("order_number")
  status          String   // completed, processing, pending, cancelled, refunded
  total           Decimal  @db.Decimal(10, 2)
  subtotal        Decimal  @db.Decimal(10, 2)
  totalTax        Decimal  @default(0) @map("total_tax") @db.Decimal(10, 2)
  shippingTotal   Decimal  @default(0) @map("shipping_total") @db.Decimal(10, 2)
  discountTotal   Decimal  @default(0) @map("discount_total") @db.Decimal(10, 2)
  paymentMethod   String?  @map("payment_method")
  customerEmail   String?  @map("customer_email")
  customerName    String?  @map("customer_name")
  itemsCount      Int      @default(0) @map("items_count")
  orderDate       DateTime @map("order_date")
  syncedAt        DateTime @default(now()) @map("synced_at")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  store   Store       @relation(fields: [storeId], references: [id], onDelete: Cascade)
  items   OrderItem[]
  refunds Refund[]

  @@unique([storeId, wcOrderId])
  @@index([storeId, orderDate])
  @@index([storeId, status])
  @@map("orders")
}

model Refund {
  id           String   @id @default(cuid())
  orderId      String   @map("order_id")
  wcRefundId   Int      @map("wc_refund_id") // WooCommerce refund ID
  amount       Decimal  @db.Decimal(10, 2) // Refund amount (positive value)
  reason       String?  // Refund reason
  refundedBy   String?  @map("refunded_by") // Who processed the refund
  refundDate   DateTime @map("refund_date")
  syncedAt     DateTime @default(now()) @map("synced_at")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([orderId, wcRefundId])
  @@index([orderId])
  @@index([refundDate])
  @@map("refunds")
}

model OrderItem {
  id            String   @id @default(cuid())
  orderId       String   @map("order_id")
  productId     String?  @map("product_id") // Local product reference
  wcProductId   Int      @map("wc_product_id") // WooCommerce product ID
  wcVariationId Int?     @map("wc_variation_id") // WooCommerce variation ID
  name          String
  sku           String?
  quantity      Int
  price         Decimal  @db.Decimal(10, 2) // Unit price
  subtotal      Decimal  @db.Decimal(10, 2) // quantity * price
  total         Decimal  @db.Decimal(10, 2) // After discounts/taxes
  taxTotal      Decimal  @default(0) @map("tax_total") @db.Decimal(10, 2)
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  order   Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([productId])
  @@index([wcProductId])
  @@map("order_items")
}

model AnalyticsCache {
  id        String   @id @default(cuid())
  storeId   String   @map("store_id")
  dataType  String   @map("data_type") // inventory, orders, payments, profits, refunds
  dataJson  Json     @map("data_json")
  period    String?  // today, 7d, 30d, 365d, all
  fetchedAt DateTime @default(now()) @map("fetched_at")
  expiresAt DateTime @map("expires_at")

  // Relations
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, dataType, period])
  @@map("analytics_cache")
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

model StoreSettingsLog {
  id         String   @id @default(cuid())
  storeId    String   @map("store_id")
  userId     String   @map("user_id")
  field      String   // commissionRate, shippingCost
  oldValue   String   @map("old_value")
  newValue   String   @map("new_value")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([storeId])
  @@index([userId])
  @@map("store_settings_logs")
}

// ==================== PRODUCT MAPPING ====================

model ProductMapping {
  id          String   @id @default(cuid())
  companyId   String   @map("company_id")
  masterSku   String   @map("master_sku")
  name        String?  // Optional display name for the group
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  company Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  items   ProductMappingItem[]

  @@unique([companyId, masterSku])
  @@index([companyId])
  @@map("product_mappings")
}

model ProductMappingItem {
  id          String   @id @default(cuid())
  mappingId   String   @map("mapping_id")
  storeId     String   @map("store_id")
  productId   String   @map("product_id")
  sku         String?
  isSource    Boolean  @default(false) @map("is_source") // Kaynak mağaza mı?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  mapping ProductMapping @relation(fields: [mappingId], references: [id], onDelete: Cascade)
  store   Store          @relation(fields: [storeId], references: [id], onDelete: Cascade)
  product Product        @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([mappingId, storeId, productId])
  @@index([mappingId])
  @@index([storeId])
  @@index([productId])
  @@map("product_mapping_items")
}

// Reddedilen eşleştirme önerileri
model DismissedMappingSuggestion {
  id          String   @id @default(cuid())
  companyId   String   @map("company_id")
  suggestionKey String @map("suggestion_key") // SKU veya normalleştirilmiş ürün adı
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, suggestionKey])
  @@index([companyId])
  @@map("dismissed_mapping_suggestions")
}

// ==================== EXTERNAL API ====================

model ApiKey {
  id            String    @id @default(cuid())
  companyId     String    @map("company_id")
  keyHash       String    @unique @map("key_hash") // SHA-256 hash
  keyPrefix     String    @map("key_prefix") // İlk 8 karakter (gösterim için)
  name          String    // API key adı
  permissions   Json      @default("{\"read\": true, \"write\": false}")
  lastUsedAt    DateTime? @map("last_used_at")
  expiresAt     DateTime? @map("expires_at")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  company    Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  usageLogs  ApiUsageLog[]

  @@index([companyId])
  @@index([keyHash])
  @@map("api_keys")
}

model ApiUsageLog {
  id            String   @id @default(cuid())
  apiKeyId      String   @map("api_key_id")
  endpoint      String
  method        String   // GET, POST, PUT, DELETE
  statusCode    Int      @map("status_code")
  responseTimeMs Int     @map("response_time_ms")
  ipAddress     String?  @map("ip_address")
  userAgent     String?  @map("user_agent")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  apiKey ApiKey @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@index([apiKeyId, createdAt(sort: Desc)])
  @@index([createdAt])
  @@map("api_usage_logs")
}

// ==================== WEBHOOK LOGS ====================

model WebhookLog {
  id           String   @id @default(cuid())
  storeId      String   @map("store_id")
  eventType    String   @map("event_type") // stock.updated, order.completed, etc.
  direction    String   // inbound (WC->Dashboard), outbound (Dashboard->WC)
  payload      Json?
  status       String   // success, failed, pending
  errorMessage String?  @map("error_message")
  productId    String?  @map("product_id") // İlgili ürün
  wcProductId  Int?     @map("wc_product_id")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId, createdAt(sort: Desc)])
  @@index([eventType])
  @@index([createdAt])
  @@map("webhook_logs")
}

// ==================== NOTIFICATIONS ====================

enum NotificationType {
  NEW_ORDER
  CRITICAL_STOCK
  HIGH_VALUE_ORDER
  REFUND_RECEIVED
  SYNC_ERROR
  SYNC_SUCCESS
  LOW_PROFIT_MARGIN
}

model Notification {
  id        String           @id @default(cuid())
  userId    String           @map("user_id")
  companyId String           @map("company_id")
  type      NotificationType
  title     String
  message   String?
  data      Json?            // Ek veri (sipariş ID, ürün ID vb.)
  isRead    Boolean          @default(false) @map("is_read")
  createdAt DateTime         @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([userId, isRead])
  @@index([companyId])
  @@map("notifications")
}

model NotificationSetting {
  id               String           @id @default(cuid())
  userId           String           @map("user_id")
  notificationType NotificationType @map("notification_type")
  inAppEnabled     Boolean          @default(true) @map("in_app_enabled")
  emailEnabled     Boolean          @default(false) @map("email_enabled")
  thresholdValue   Decimal?         @map("threshold_value") @db.Decimal(10, 2) // Yüksek tutar eşiği
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, notificationType])
  @@index([userId])
  @@map("notification_settings")
}
